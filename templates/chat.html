
{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="new-conversation-button-container">
            <a href="{{ url_for('new_conversation') }}" class="btn new-conversation-btn">New Conversation</a>
        </div>

        <div class="conversation-list">
            <h3>Your Chats</h3>
            {% if users %}
                <ul>
                    {% for user in users %}
                        <li>
                            <a href="{{ url_for('chat', username=user.username) }}">{{ user.username }}</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>You have no conversations yet.</p>
            {% endif %}
        </div>
    </div>

    <div class="chat-area">
        <h2>Chat with {{ partner.username }}</h2>
        <div class="message-history" id = "message-history">
            {% for message in messages %}
                <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                    <p>{{ message.content }}</p>
                    <span class="timestamp">{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
            {% endfor %}
        </div>
        <div class="message-form">
            <form method="POST" action="{{ url_for('chat', username=partner.username) }}">
                {{ form.hidden_tag() }}
                <div class="form-group">
                {{ form.message(class="form-control", placeholder="Type a message...", id="message-input") }}
            </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { // Submit on Enter, but not Shift+Enter
                    e.preventDefault(); // Prevent default new line
                    this.closest('form').submit();
                    this.closest('form').reset();
                }
            });
        }
    });

  const socket = io();

  socket.emit('join', {username:"{{current_user.id}}"});

  socket.on('receive_message', (data) => {
    console.log( data );
    
    if (data.sender == "{{partner.id}}") {
      const li = document.createElement('li');
      li.innerHTML = 
       `<div class="message received">
                    <p>${data.text}</p>
                    <span class="timestamp">${data.timestamp}</span>
        </div>`;
      document.getElementById('message-history').appendChild(li);
    }
  });
</script>
{% endblock %}
