<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization</title>
    <style>
        body { background-color: #111; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: Arial, sans-serif; }
        canvas { background-color: #000; border: 1px solid #444; }
        p { margin-top: 20px; }
    </style>
</head>
<body>

    <canvas id="visualizationCanvas" width="800" height="600"></canvas>
    <p>Click on the canvas to regenerate the layout. (Check console with F12)</p>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- 1. SETUP ---
            const canvas = document.getElementById('visualizationCanvas');
            if (!canvas) {
                console.error("CRITICAL: Canvas element not found!");
                return;
            }
            const ctx = canvas.getContext('2d');

            // --- 2. DATA LOADING & DEBUGGING ---
            
            // **DEBUG STEP 1**: Log the raw string from Flask before parsing.
            const rawDataString = '{{ data|safe }}';
            console.log("Step 1: Raw data string received from Flask:", rawDataString);

            let data;
            try {
                // This is the line that was likely failing.
                data = JSON.parse(rawDataString);
                
                // **DEBUG STEP 2**: Log the data after it has been successfully parsed.
                console.log("Step 2: Data successfully parsed into JavaScript object:", data);

            } catch (e) {
                console.error("Step 2 FAILED: Could not parse the data string.", e);
                // Draw an error message on the canvas itself
                ctx.fillStyle = 'red';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Error: Could not load data.', canvas.width / 2, canvas.height / 2);
                
                // **DEBUG STEP 3**: Give a hint in the console.
                console.error("Hint: Check if the string in Step 1 is valid JSON. It might be empty or contain escaped characters like '&quot;'. If it does, the '|safe' filter might be missing in your HTML file.");
                return; // Stop the script if data fails to load
            }

            // --- 3. CONFIGURATION ---
            const pointRadius = 15;
            const solidLineThreshold = 350;
            const dottedLineThreshold = 500;

            let points = [];

            // --- 4. FUNCTIONS ---

            function getDistance(point1, point2) {
                const dx = point1.x - point2.x;
                const dy = point1.y - point2.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            function generatePointPositions() {
                points = data.map(item => ({
                    name: item.name,
                    color: item.color,
                    x: pointRadius + Math.random() * (canvas.width - pointRadius * 2),
                    y: pointRadius + Math.random() * (canvas.height - pointRadius * 2)
                }));
                // **DEBUG STEP 4**: Log the final array of points with their new coordinates.
                console.log("Step 4: Generated point positions:", points);
            }

            function drawConnections() { /* ... function unchanged ... */ 
                for (let i = 0; i < points.length; i++) {
                    for (let j = i + 1; j < points.length; j++) {
                        const distance = getDistance(points[i], points[j]);
                        ctx.lineWidth = 1.5;
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                        if (distance < solidLineThreshold) {
                            ctx.beginPath();
                            ctx.setLineDash([]);
                            ctx.moveTo(points[i].x, points[i].y);
                            ctx.lineTo(points[j].x, points[j].y);
                            ctx.stroke();
                        } else if (distance < dottedLineThreshold) {
                            ctx.beginPath();
                            ctx.setLineDash([5, 10]);
                            ctx.moveTo(points[i].x, points[i].y);
                            ctx.lineTo(points[j].x, points[j].y);
                            ctx.stroke();
                        }
                    }
                }
            }
            
            function drawPoints() { /* ... function unchanged ... */ 
                points.forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, pointRadius, 0, Math.PI * 2);
                    ctx.fillStyle = point.color;
                    ctx.fill();
                    ctx.fillStyle = '#fff';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(point.name, point.x, point.y - pointRadius - 8);
                });
            }

            // --- 5. MAIN DRAW FUNCTION ---
            function render() {
                console.log("--- Calling render() ---");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                generatePointPositions();
                drawConnections();
                drawPoints();
                console.log("--- Render complete ---");
            }
            
            // --- 6. INITIALIZATION ---
            render();
            canvas.addEventListener('click', render);
        });
    </script>
</body>
</html>